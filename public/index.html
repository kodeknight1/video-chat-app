<!-- public/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Minimal WebRTC Chat</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #000;
        overflow: hidden;
      }

      h1,
      p {
        display: none;
      }

      #remote {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        background: #000;
      }

      #local {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 200px;
        height: 150px;
        border-radius: 10px;
        border: 2px solid #fff;
        background: #000;
        object-fit: cover;
        transform: scaleX(-1); /* Mirror the local video */
        z-index: 10;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }
    </style>
  </head>
  <body>
    <h1>WebRTC Video Chat</h1>
    <p>Open in two tabs, one with <code>#1</code> in the URL.</p>
    <div class="video-container">
      <video id="local" autoplay muted playsinline></video>
      <video id="remote" autoplay playsinline></video>
    </div>

    <script src="https://unpkg.com/simple-peer@latest/simplepeer.min.js"></script>
    <script>
      const local = document.getElementById("local");
      const remote = document.getElementById("remote");

      // const ws = new WebSocket(location.origin.replace(/^http/, "ws"));
      const ws = new WebSocket("wss:///video-chat-app-nftr.onrender.com");
      // const ws = new WebSocket("ws://localhost:3000");

      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          local.srcObject = stream;

          const peer = new SimplePeer({
            initiator: location.hash === "#1",
            trickle: false,
            stream,
          });

          console.log(
            "I am",
            location.hash === "#1" ? "initiator" : "receiver"
          );
          peer.on("signal", (data) => {
            console.log("SIGNAL:", data);
            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify(data));
            } else {
              ws.addEventListener(
                "open",
                () => {
                  ws.send(JSON.stringify(data));
                },
                { once: true }
              );
            }
          });

          ws.onmessage = (msg) => {
            console.log("GOT SIGNAL:", msg.data);
            const signal = JSON.parse(msg.data);
            peer.signal(signal);
          };

          peer.on("connect", () => {
            console.log("Peer connection established!");
          });

          peer.on("stream", (remoteStream) => {
            console.log("Receiving remote stream");
            remote.srcObject = remoteStream;
          });
        });
    </script>
  </body>
</html>
